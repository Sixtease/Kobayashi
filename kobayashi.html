<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>Kobayashi</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<style>
body { font:80% Verdana,Tahoma,Arial,sans-serif; }
h1, h2, h3, h4 {  font-family: "Trebuchet MS",Georgia,"Times New Roman",serif; }
ul.toc { padding: 4px; margin-left: 0; }
ul.toc li { list-style-type:none; }
ul.toc li.heading2 { margin-left: 1em; }
ul.toc li.heading3 { margin-left: 2em; }
</style>
</head>
<body>
<h1 id="Kobayashi-Content-By-Hash-library">Kobayashi -- Content By Hash library<a href="#Kobayashi-Content-By-Hash-library" class="wiki-anchor">&para;</a></h1>


	<p>Depends on jQuery 1.3</p>


	<h2 id="Exported-Functions-Constants-and-Objects">Exported Functions, Constants and Objects<a href="#Exported-Functions-Constants-and-Objects" class="wiki-anchor">&para;</a></h2>


	<ul>
	<li>ContentByHashLib</li>
	</ul>


The object encapsulating the library's interface
	<ul>
	<li>ContentByHashLib.DEFAULT_TARGET</li>
	</ul>


ID of the element where AJAX'ed stuff is injected if no target is specified.
	<ul>
	<li>ContentByHashLib.ADDRESS_POSTPROCESS</li>
	</ul>


	<p>An object mapping addresses (that are to appear in hash specifiers)<br />
to their postprocessed variants.</p>


location.hash will be automatically updated when an address to be postprocessed is requested.
	<ul>
	<li>function ContentByHashLib.reload_content(container_id)</li>
	</ul>


If an URL is loaded into the container given by its id, then it is reloaded,<br />
otherwise its BASE_URL is loaded. If no BASE_URL is defined either, the whole page is reloaded.
	<ul>
	<li>function ContentByHashLib.unload_content(container_id, options)</li>
	</ul>


Deletes the record of any address being loaded into the corresponding container.<br />
One effect of this is that subsequent requests for loading are actually executed.<br />
Another effect is that the container is emptied. This can be prevented by setting options.keep_content to true.
	<ul>
	<li>function ContentByHashLib.simple_load(specifier)</li>
	</ul>


The function called on click on an <code>&lt;a class="js-simpleload"&gt;</code>.
	<ul>
	<li>function adr(address, options)</li>
		<li>function get_hashadr(address, options)</li>
		<li>function get_adr(address, options)</li>
	</ul>


See <a href="#Relative-Addresses-Beyond-Hash-Mark-in-URL" class="wiki-page">Relative Addresses Beyond Hash Mark in URL</a>
	<ul>
	<li>function request_media(url, success_callback, error_callback)</li>
	</ul>


See <a href="#Media-Loading" class="wiki-page">Media Loading</a>
	<ul>
	<li>function arr2map(array)</li>
	</ul>


A general-purpose function for converting <code>[a,b,c]</code> arrays into <code>{a:1,b:2,c:1}</code> objects.
	<ul>
	<li>function alert_dump(object, name)</li>
	</ul>


<em>Debugging function.</em> alerts the keys and values of an object.
	<ul>
	<li>function carp(anything, ...)</li>
	</ul>


Passes its arguments to console.log and appends them to the <code>#debug</code> div.
	<ul>
	<li>BASE_URL</li>
	</ul>


The path to the index page, with trailing slash
	<ul>
	<li>BASE_PATH</li>
	</ul>


Like BASE_URL only without trailing slash
	<ul>
	<li>function prepend_base_path_to(url)</li>
	</ul>


	<h2 id="ContentByHashLib-API">ContentByHashLib API<a href="#ContentByHashLib-API" class="wiki-anchor">&para;</a></h2>


	<p>Links (&lt;a&gt;) with <code>class="js-hashadr"</code> or inside an element with <code>class="js-hashadr-container"</code><br />
will call function <code>adr</code> passing it their href attribute as parameter<br />
and stop following the link.</p>


	<p>This will change location.hash and load stuff into an appropriate element (<code>ContentByHashLib.DEFAULT_TARGET</code> by default),<br />
reflecting this at the URL in the address bar.</p>


	<p>Links with <code>class="js-simpleload"</code> or inside an element with <code>class="js-simpleload-container"</code><br />
will call function <code>js-simpleload</code> passing it their href attribute as parameter<br />
and stop following the link.</p>


	<p>This will load stuff into an appropriate element, not affecting the URL in the address bar.</p>


	<p>Upon injection of content, the target element is shown by default.<br />
Presence of the <code>js-noautoshow</code> class overrides this.</p>


	<p>Whenever content is loaded as triggered by <code>hashchange</code> event or <code>simple_load</code> function, the custom <code>content_added</code> event is triggered.</p>


Classes:
	<ul>
	<li>js-hashaddr</li>
		<li>js-hashaddr-container</li>
		<li>js-simpleload</li>
		<li>js-simpleload-container</li>
		<li>js-noautoshow</li>
	</ul>


	<h3 id="Hash-Address-Language">Hash Address Language<a href="#Hash-Address-Language" class="wiki-anchor">&para;</a></h3>


	<p>location.hash is interpreted as a sequence of specifiers delimited by "<code>#</code>" characters.</p>


	<p>Each of those specifiers is passed to the <code>adr</code> function, see <a href="#Relative-Addresses-Beyond-Hash-Mark-in-URL" class="wiki-page">below</a></p>


	<h2 id="Relative-Addresses-Beyond-Hash-Mark-in-URL">Relative Addresses Beyond Hash Mark in URL<a href="#Relative-Addresses-Beyond-Hash-Mark-in-URL" class="wiki-anchor">&para;</a></h2>


	<p>Function <code>adr</code> is the cornerstone of handling addresses in the specifiers in <code>location.hash</code>.<br />
It receives two arguments:</p>


	<ol>
	<li>A specifier</li>
		<li>Options object</li>
	</ol>


	<p>Specifiers can be in three distinct formats:</p>


	<ol>
	<li>URL

	<p>Example: <code>/articles/article/</code></p>
</li>
		<li>target_id::URL

	<p>Example: <code>passwd-container::/password_change/</code></p>
</li>
		<li>target_id::relative-address-base::URL

	<p>Example1: <code>history::content::history/</code><br />
Example2: <code>history::::history/</code></p></li>
	</ol>


	<p>Format 1 is a shorthand for <code>content::URL</code>, i.e. omitting the target ID substitutes value of "<code>ContentByHashLib.DEFAULT_TARGET</code>" as a default.</p>


	<p>Specifier in format 2 says that an URL should be loaded from the given URL and the response injected into the element with the given ID.</p>


	<p>Format 3 makes it possible to use a relative address to address from another specifier.<br />
Relative address operate on the address <em>up to</em> the first "?" or "#" character in location.href.<br />
Suppose you are at this location: <code>http://newman.myproject.org/#content::/articles/article/118/</code><br />
and you want to load a deletion confirmation to the "<code>delete-dialog</code>" element. Say the delete confirmation can be loaded from<br />
<code>/articles/article/118/delete</code>. Using a relative address directly, like at<br />
<code>&lt;a class="hashadr" href="delete-dialog::delete/"&gt;</code> would result in this address being used:<br />
<code>http://newman.myproject.org/#content::/articles/article/118/#delete-dialog::delete/</code> and that would load<br />
<code>http://newman.myproject.org/delete/</code> into #delete-dialog, which is not what you need.</p>


	<p>Enter format 3: saying <code>&lt;a class="hashadr" href="delete-dialog::content::delete/"&gt;</code> means:<br />
Take the address loaded into <code>#content</code>, take it as a base for the relative address "<code>delete/</code>" and load it into "<code>#delete-dialog</code>".</p>


	<p>Leaving the middle part (relative-base) empty is the same as putting <code>content</code> inside, so<br />
<code>delete-dialog::content::delete/</code> could be equally written as <code>delete-dialog::::delete/</code>.</p>


	<p>Second parameter for the <code>adr</code> function -- options -- is optional. If present, it must be an object. Two keys are recognized:</p>


	<ol>
	<li>hash</li>
		<li>just_get</li>
	</ol>


	<p>Normally, function <code>adr</code> looks at <code>location.hash</code>, modifies it as the specifier dictates and assigns the result back to <code>location.hash</code>.<br />
<code>options.hash</code> and <code>options.just_get</code> override this.</p>


	<p>Set <code>options.hash</code> to whatever string you want function <code>adr</code> to look at instead of <code>location.hash</code>.<br />
Set <code>options.just_get</code> to a true value if you want function <code>adr</code> to return the result instead of applying it to <code>location.hash</code>.</p>


	<p>A shorthand for <code>adr(_specifier_, {just_get:true})</code> is available: <code>get_hashadr</code>.<br />
Function <code>get_adr</code> does the same and prepends <code>BASE_PATH</code> in front of the result.<br />
Both of these accept the same arguments as <code>adr</code>, so you can still set <code>options.hash</code>.</p>


	<p>Use function <code>get_adr</code> to get addresses directly usable in conventional hyperlinks.</p>


	<h2 id="Media-Loading">Media Loading<a href="#Media-Loading" class="wiki-anchor">&para;</a></h2>


	<p>Since everything is loaded into a non-reloading page, all needed CSS and JavaScript files must be loaded at the starting page. This is impractical and slows down the initial load. On the other hand, if the JavaScripts were inside the loaded pieces, then they would be loaded and run repeatedly, which is undesired.</p>


	<p>To remedy this, the <code>request_media</code> function is provided.</p>


	<p>Its only argument is an URL of a medium to be loaded. The type of the medium is recognized by the suffix of the URL. Currently, only .js and .css files are recognized. Re-requesting already loaded media is ignored. When the requested media are loaded, the <code>media_loaded</code> event is fired. Calling the function several times in a row results in sequentially loading the media, waiting for each other to address library dependencies and CSS priorities. The media_loaded event is fired after the whole bunch of media are loaded.<br />
If a library needs to re-run some code when new content is loaded, it should not rely on <code>request_media</code> being called. Rather, it should bind a desired function to the <code>content_added</code> event.</p>
</body>
</html>
